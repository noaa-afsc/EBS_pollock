---
output: html
title: "Eastern Bering Sea walleye pollock stock assessment"
subtitle: May 2025, CIE review
author: "Jim Ianelli and Carey McGilliard"
date: April 2024
editor_options: 
  chunk_output_type: console
editor: 
  markdown: 
    wrap: 90
---

```{r startup, echo=FALSE, warnings=FALSE, message=FALSE, eval=TRUE}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(ebswp)
library(tidyverse)
library(patchwork)
library(gganimate)
library(ggridges)
library(viridis)
# Set ggplot theme
#devtools::install_github("seananderson/ggsidekick")
library(ggsidekick)
theme_set(theme_sleek())
library(reshape2)
.OVERLAY <- TRUE
.THEME <- ggthemes::theme_few()
options(warn = -1)
do_sigmaR_profile=0
do_anim=0
do_abc_sel=0
do_yearloop=0
do_srrlst=0
do_selsens=0

Plot_Sel <- function(sel = all_sel, fage = 1, lage = 13, nages = 15, styr = 1964, endyr = 2023) {
  sdf <- pivot_longer(sel, names_to = "age", values_to = "sel", cols = 2:(nages + 1)) |>
    filter(Year >= styr, Year <= endyr) |>
    mutate(age = as.numeric(age))
  p1 <- sdf |> ggplot(
    aes(x = age, y = as.factor(Year), height = sel)
  ) +
    geom_density_ridges(
      stat = "identity", scale = 2.8,
      alpha = .3, fill = "goldenrod", color = "tan"
    ) +
    ggthemes::theme_few() +
    ylab("Year") +
    xlab("Age (years)") +
    scale_x_continuous(limits = c(fage, lage), breaks = fage:lage) +
    scale_y_discrete(limits = rev(levels(as.factor(sdf$Year)))) +
    facet_grid(. ~ source)
  return(p1)
}
```

# Executive Summary

## Summary of Changes in Assessment Inputs

The work presented below was based on the same data sets used in the 2023 assessment. The
model was updated so that it could handle a number of requests from the SSC. We enhanced
the capability of the code to deal with some alternative hypotheses of factors that affect
the stock recruitment relationship (SRR). We stepped through a number of sensitivity
analyses to evaluate the stock-recruitment relationship (SRR) and the steepness of the
SRR. We also evaluated the impact of including the natural mortality-at-age estimates from
CEATTLE model.

## Summary of Results

```{r ft1}
#| echo: false
#| warnings: FALSE
#| messages: FALSE
#| label: fig-ft1
#| fig.cap: "Model results comparing last year's selected model -2021)"
if (do_ft1) {
  ft <- list()
  ft[[1]] <- read_rep(here::here("runs", "last_yr_db", "pm.rep"))
  ft[[2]] <- read_rep(here::here("runs", "last_yr_db_ae", "pm.rep"))
  ft[[3]] <- read_rep(here::here("runs", "ftnir1", "pm.rep"))
  ft[[4]] <- read_rep(here::here("runs", "ftnir2", "pm.rep"))
  names(ft) <- c("2024 TMA", "2024 TMA w/age-error",
                     "FT-NIR fleet-specific",
                     "FT-NIR fleets aggregated"
                     )
  saveRDS(ft, here::here("runs", "ftnir.rds"))
} else{
  ft <- readRDS(here::here("runs", "ftnir.rds"))
}
plot_srr(ft[c( 4,3)], alpha = .2, xlim = c(0, 4200), ylim = c(0, 95000), sizeout = 3, sizein = 3, yrsin = c(1964:2021), ebar = TRUE)
plot_recruitment(ft[1:2])
plot_recruitment(ft[c(2,4)])
plot_recruitment(ft[c(3,4)])
p2 <- plot_ssb(ft[c(4, 3)], xlim = c(1979.5, 2024.5), 
               breaks = seq(1964, 2024, by = 4), alpha = .2); p2
plot_ssb(ft[c(3,4)])
plot_agefit(ft[2])
plot_ssb(ft)
?plot_ssb

# Set working directory & plot save directory
this_year <- 2024

#workDir <- here("species_specific_code","BS","pollock")  # define working directory
#save_dir <- here(workDir, "results", paste0(this_year, " production"))

# Read in proportions & shape for plotting
proportions <- data.frame(ft[[1]]$pobs_bts)
prop_ftnir <- data.frame(ft[[3]]$pobs_bts)

names(prop_ftnir)[1:16] <- c("Year",1:15)
names(proportions)[1:16] <- c("Year",1:15)
props <- pivot_longer(proportions, cols=2:16, 
              names_to = "Age", values_to = "Proportion") |> mutate(Age=as.numeric(Age))
prop_ftnir <- pivot_longer(prop_ftnir, cols=2:16, 
              names_to = "Age", values_to = "Proportion") |> mutate(Age=as.numeric(Age))
props <- rbind(props,data.frame(Year=2020,Age=1,Proportion=0))
# Only EBS age comp
props_ebs <- props %>% 
  arrange(Year, Age)
props_ftnir <- prop_ftnir %>% 
  arrange(Year, Age)

# Set up shifting colors for each year to track cohorts
colors <- rep(1:16, length(1982:this_year))

colors
props_ebs$color <- colors[1:nrow(props_ebs)]
props_ftnir$color <- colors[1:nrow(props_ftnir)]

prop_plot <- ggplot(props_ebs, aes(x = Age, y = Proportion, fill = color)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_line(data = props_ftnir, aes(x = Age, y = Proportion),  size = .5) +  
  scale_fill_viridis(option = "turbo") +
  scale_x_discrete(breaks = c(1, 5, 10, 15)) +
  scale_y_continuous(limits = c(0, 0.5), breaks = c(0, 0.2, 0.4)) +
  ylab("Proportion") + 
  guides(fill = "none") +
  facet_wrap(~ Year, ncol = 4, dir = "v") +
  theme(strip.text.x = element_blank()) +
  geom_text(x = 13, y = 0.45, aes(label = Year), color = "grey30", size = 2.8)
prop_plot

ggsave(prop_plot, filename = here(save_dir, "Age_comp.png"),
       width=120, height=180, units="mm", dpi=300)

```